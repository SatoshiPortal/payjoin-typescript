import { PayjoinSenderBuilder, PayjoinHttp, PayjoinRequest, PayjoinOhttpKeys, PayjoinReceiver, PayjoinSender } from '../src/index';

const address = "bcrt1qg2yk630h3x7vjpecquny8m27pkyx547gsnu23t";
const amount = 10000000;
const directory = "https://payjo.in";
//const relay = "https://pj.bobspacebkk.com";
const relay = "https://ohttp.cakewallet.com";

async function generateMockPayjoinUri(): Promise<string> {
  // Fetch OHTTP keys
  const ohttpKeys = await PayjoinOhttpKeys.fetch(relay, directory);
  
  // Create receiver with 1 hour expiry
  const receiver = new PayjoinReceiver(
    address,
    directory,
    await ohttpKeys.toBytes(),
    relay,
    BigInt(60 * 60)
  );

  // Get fresh URI
  const uriBuilder = receiver.getPjUriBuilder();
  uriBuilder.amount(amount);
  const uri = uriBuilder.build();

  return uri;
}

const response1Hex = "fe31a4f2bebbb9f1d61ef5d12cd9a8a51689585470aaccd2355dc4e5faadcc48564f2fa74b1a272a22d722b6264103c807b24c91e26c0bcbfdd0abdb9a4719dc691dc04a6d65fa64fb81e011201f5fc00df2e9614f929d51e0c15c2affda4968aa5bdf2e5975f27610ce43a06e9398c25979464e1d3d802f2ad4dab506a5a19ce6b4f9dcf4c3edf6003c82799c75ff37106b1c9cc6a78eef477a34427cd3cffa673971f813cadd7ab885d13a27b272903e7ce35084de4aa768368a6438eb32fbbaa4a0ccc9e0c631ee104353c229acd25ba4ec531ea040f4e166b8f4e91e7d9e9a83198d4f767afd6c6db885645d4d7c8015cecee758a244a6d9ddb099ee5c2bbd505eb4ba15c1968d2ef3683965fbdf0a758b89f07d9a0f6924eb780228fe2833e91ac0ffd76fb209178d7b9d72033c74413af7160eff4e486e4639795dce1bc21fa4d622552700abe72904a8c0bc3c6cf849e7bd907d05bc6f0441daf09a3152e9dda978fefb4e589b6447ea587e7b1296da296224682bf4da3649b6575cebaacf8820c568eed07d3175a553608bb363712ac7616285df98d55b07c3eb867f6264a39397e5f55a5df7f1bbff73d43ba46d4d986b549b6dd174691a20e4ffb736e21f4fa961b17697841de618cb05351d5792707794755165ef0458166e8cd1e808ab059a3e44cf2740c098d0b7bb78d99fd3fc0bb19405c9d40430b7025bc05e386b3bbc310b37e60ce636b40e197a5b883f9cc478392beb9904863fc79a9dc5840fa2ade7062568482d2b347fe4fb47faa244bacabe63f6905f5bb8350e45d3b04d4349b747cb3f7f70c703a9d49999b4226808c774d0c9deee9927eeb966489cfd842cbeb6b666a23fe2adfa971b72a3a3b37756bd13bbad0ef5ed8ad0c85a2302f12b2f05f213b4a9607ddae3318275aa5f94f336c9c774a9ebec2bf0b8c7883885355f9b7ddf493cd5c01ba8a49ed331d6dac4911e28e5b867aca2b4c7ce1be5c0ebc015c202d1b6c23d254d18513da1ec2d1c9dbf52a05987a012947e1c0d2c494833a451b87a9bc27cf076a4938bafae0d47c9a11ce335b30cebc50e02d74cee6832abcd2898da3ef8b37332cf1131ef4e8bf9e73d402ea027405b9826116b4d15241d0c31dbdca51337b82c5f462c7aeefaf71e10407a205c241497a859e646157f5812d313f73901e0218300b8af41fa0b36fef326d9c60d808e4652b99d1362e1d7c79572721f36b9ad0302aa468c5ac142f96bd01f6afd36121b3b4a1a3b9ccf4fc6fc45dc820e3afabc199f0a4bfb40a358cfc137f40ff3caa72d35da1e38fb70aa9c99ab9638e5486e727acaee9bf08a377b3542429d1a56828c14349efafe38065c1ba95fcb273d5ada6cdc28a6c5f80f223381c400c6bf93726764f99d8debb48ec6f17a1d2c7889f118fc3192e8c1e5594d898a064fb0093eb0052c595794a1280fad9234b630e4532541a04a387d7efd25307ea884842d1fe4f5822c96fc28f2e885cedd99123dba59da42a9a041d63d4706894f53ebc160381997569247a7a57096b3db5d8252c3f0a4d6071254dd4c3cd00054d6e74b671e8b6d34b01c80cc0de94a5fa39dd06361d07dd9e4e98abd36849089c0ee7777366494918ba59db612f25530f7216260803b8e5b85bb01c84e1fe200330cf3a9ce139f9012ec3e7fb100509912c2448b1c02a76a2951e9c34a2c2c9a359b962db2b85c456b4de040d7d83cfb419777033f9fde66cb12324af038f3b1b523a5ab8d2988de2900516a86011da327522d3616baa283d0faaf9ab56db1995200f33ded6a5e7be80293bbc621e2b5a3b1894e51bd6822dcf9f5b66ba7a05a0312b2dfac1495f25028a690a6cd40e455bdb7cd07e2193aeb4b5b004d105aeada9dfae49e67652e9c13e92d899cb096759d3ecdba5f689022047a537cdaf3bea5605725fa51feb074d9f566e262ed313bcb9853088eecce09883c31664e167379c51869e12bfc10bd7f689e99c20e1e53adb18b45a6314fd00c643d12b5baab1262b4eb79f7ad53c4872b2d229abd443f181e385ccec301803c64055fe89f494ab592df6aad4d56c1a3f1a0d21f4c7e951f16e5a1dee0e30caa77873fa43c101ed2001f6e852207f0077dc3f8abb2e78643af3c5a09eb89d47b6a3f81fe854813ff25516338ac3ac389bcccbd1d3efad2f62603ae9c25157ff0c0400f959f596becfd86dbde30a07679cf6ea8bb3a9590df3e1d3295f2e021ea6a49cb774a242df140d767ff6a237cd79abb88b62b004cbcb38c8763dcf24df665b46b37e30990b505dafbc36dc3b65446bb5dd6e323208c5063ca3a833263188d7eeeaab4d369747081fef8b3ea232883c1956c1f273353a2342cdd9051718cccebd346525f2ff1508acb3a3bc1858d199685ea3ca99beb65a8531fdc4d086b3b20fc7d2c794b3da5bf337bb1f1d5855ebb6e7528fb0276cf6e816be284540e9e063d774f0782edac4e3f4a3ae1a2286f76f13000608fa00547e13e02e6426f4439ff0f83c6b07579f3e2bbc204fa4f00d328ea93f083277ed82f9e542087dc21191beb7cad918ad2d3e99439f915aca0cdd3db928fbaf28eae52c4e3f94fb0301aaf3329e9879b7329fbd10e5ee021ceb22eedb5d1e6933e811cc235f4a1e77fa68486ea35432cdcaea556725764007f59af17ee417171116ffaf5f5190aaf3c6ae49030be445a165a3ee61bb222bd14c18b4b6fe8cac893a8c7cad837ab1967b7b30d895a1c881378a7ef571a18f41843e2699be54a8c13f02360910f281cc185b5d42230c87fb955f8cdd7e6de35a83327d0a548b305ac923455f0e8a44250cc15ac3a77205da9dd6b33e282ac5b087dc9aca63e440dc3c1930fa373d4832968d35b3de962f7ebb950bec95812c5b16e272b741774454810fe493bdd834cd27c13922550063e5adb8335ab2ab63efaba0d08c78b1c0be42c79e1061051b5e2a316a36386bbd34d45fa3189844643a7c122636dbd3868dbcc59889f42c001c43d0f0950d284af514075adcd108f121d738501b72c851c0779d97a194188009b86f79bc4044f820cb6cf3406a9a9ece2b769eee7ac3ce6378e65e757d7f34cd6328629297e028bcf0b9620e6f47be696e05796cc28e2fe4af9a6a4c8d345d2c1d586d5a1bebb4812ddaebf5fba77a52290f455c0739aecfd014099eda1eb65a5194074cae123c3d938bb014d0af04978296475fd8adba5d1b9307b51e9f793687c9bbddac8843dbc1414a2041bc7f0e1dd39b3b6d811127c4fcd331d1f27fbaa2ea4b4ec0083853e111f0608ed6fb7044732ffdd56ccc99c9a55c6c2c15de58e74ca015f4ee8a818abc58b37fc2287e208aebd94c4a70aa36d73faa0ef4f112a0b52db363574802a9b79bd28b4aba11dcd046e84a84e2013ddd29cf046b60adb4631bba87bd1fe8aac2cb87f7bb000fcf528f4c9129e1b77371793dbb4ae6ab4576a771e459adb5c3c179e744cfe7332062def92ed76819d37a31c35013bd6749d6cf6a4cb0030690487ff4d76a04046e0265d8eb3e266b0241e6305d41bd20093bd750916f251b4cd8f06227797108d5f94a9de3f121a43012661e60807c87e7db1ae545ce3e01d3adfae713b87ad2f648937f6bdbacdc2b488ab291f686794ba136e3ca2aec9939e3d395dd4768c6005e91e1c1a0014a6e8fd12dac0470d493cb0c09166e387b2caba7c27ebc978dbb1614c37159e5716128d80d7fe73c71c82cd5ccea6682df205f9cdb3b741c7c917ab809a4633efe49d2c0c66b9e0f416b84952cbf527f4cc19e9286abede0bb9e522edb6d0fa6e5b7014daa2ba59db3e844b9733d89f8509c41dc071554ebb8156082d6754668a2eee068f28069586aab0da7a441925c8f3ddfc0025447f25a86520d738544cb59bc4e6e628fdc0462d0e2ab3aaf19d5bb15a4eaef189fefcef0ba4a159bb7ea5c5c0d4ace43df5379a006241729e5d0c1fdbcc84ed29836f0fb7768d017ac33a5d64ebfa431e4ef35f0ae5ac9fd767e0d660665f79997635855bccb90b7b1d5b0e37a737b119ff725330c028ab164ce0dce493fe393f5f0931bdb6bbc6f52b48b7fea081f0e88e576780dad18e9f756194def4a8db0f9a826d506cce60610df5cfd7b442bab48fcf70b39d6b4b38811e40bc7243870c47cca340e305665389f11cb40e0fb30c8fbfd3be7c92c08ce368597225a43d617fb57250722e77b34dc45dd4dfcad457bd60d7a1d217adc9f69995a9940818d06a62e52cd2adf928692a2ef91701ccd776290026939fc45aa8e103388e7597cc41b52ed3b0b9d60fe4b7b3ae8657accbb84e440a0284cf4cd3d29bdd0acb0f4eeb1ed206395dcd6564c2ddf5ea5894f82af74562bb11f0a8d3b8623a832599aeb2439dc8408d89178bf949ffc28c242870c8c9acbe4e3c5ee7a0e5091ab3a47956e7f52a4cd181d4d29f38cfcb8475dd2f651e62a62421d64938cad59c2abf435cc140bc7bf4e55ef5ba86ebb7b8419ca1d7e2a266ab2f16b010d823fc12b9f268f09ad3ae84ab3e8437422228c153c4cf874539be91b80cb4b06b75c04b2bddb097c245171fbf17ed9d4de0a0686501c1f624e40e55162f9675af8b716b020ddfaf4b8b8492f570a2031cc6f89e4010a8f4aa3f6cfcdcb1acd52466655b891495c285336e4f1069f30268a8f06636b8116de85c5ef84c65468611f8b7d801158edf2bf081b90484f2e418fa2f3b5f36a5478efe97505f3ea11f45a0dbf37c797400bc8c49628947c0998ee04407ef350db40253a0f3c88a99f6c34e0d2d7c630337d47d6ca94e6f951a3b78bd6568d7a8f4c2bc0a52673c22e1dbc6c8963e877db10da835835773479ef063c7d24ce488f9b9e2085135a545a3c2717bb21ca8de061dd130e317b0761bfc2b02120650bc02634a23003effa286e022cf51c343f3092ce9b9dc3ea046d9254bb3ed8f6d8b64a36e2becff7522be00250d06515c0dd479bca712dcb76e289617e71ac801cdab7e15c914531891b53abbbb676b70826413ed7b2e70eb791f4cb748278116bb12ec51ef9f0aa0e27ab1744bb082e1506e15ce6324c0f8f0acaa584821f5f0731459e9d570bba42baffe54eaacddb950bf3ffdd0efecf5109e3ca2272eeae96127de83eb20684edd692dc4d3620b75a44da4266ae7e24443013d0702799559b35f5ef0000b7f5a7c2f63a42bc1c3f92e0081085d4316e476d3d8e7bd455cb867eb89134c2df2af2bcbe052f7059de7241edac5ab36b7392b9f528a70f9c92cf067848caf6a4b25ae31aa9e4e1087713a12a596cd180cef6515ade6cdf0cd43521d6c000c3305e3dcb37a3714412e9dd37ec77761c2ca2369c064a6c588b523e6493bea85d0bf10b7b6ac5682e3bc1240c7c59aef129b7ef7b27216ac83f87af7112af8199fe8cb1480cbe052c8e317bd46ed823fa04fd34e0fbdad86532785930ad18551820e01235a2e3e07ed8ae79bdc053ecfb653cb82952a6d8f801b762900ff64e842a39c3b7fbb76ec73bc02b599fc8f047d5d58a2efb89f575e7ad723ed7bfb78b8a9c560fa8b3982794af0ab11f89fc856fe5a823aebab315cb6a7a0ae33bcdeb0b3778961815447fc130bb4d0bc559d3893e1628f41b13d0525600f3a6d9bff23b1e01116d40cf8a99abd23e1a8fac032e0969ef437ee0d692bfdc5e35b7779030546bc5305a811e5286c532558287ca1dfba27b4a4578c14e6fc946ab7fa7f57e4ebef6b37fc39de98c440b79f02443443bd70824b35814bc8c0c5ad003d5a25f12264aa0786d4fbb91865cd804e7908b2cf72077fe7634485c9d1acc319a901fbfa6b262a48428b3e24bcd3e526d506de333dcac84e19c90ce41f981576d3f46555697f02427663fd03800bca34d99402f890584c7a8b588ff124fe611cb88115675710c37bc4721bdba92b7017ee5bbe0ed26db122ac9202f0e696c73b955ffe8b7fa2ca28e18b81652d660b56ad9cee0f671d7d4a9e472d2fb1b1adcf3de0d919ab8332a3cecdfae187fd2dd848b9e6ec3dc276fe3d2f0bc1835cb7679ef396c8883cb9392f762922f454ca5436e09d1058fd3945ce2596fbcc734277401a61e81478a7b0d1a3434da7ab201c9d6da45a7f9ff2ebfe657d79b3fc2da7e0ee529673647e198dc200cbb41a6150276f3fcb40258db86042394d51246029a809d45eae2978b02f42007c29850bbaa622d5428866573afec422cf6ae63ac43b6df11441f5459bbdf292b4b5b5c14a7d2d609aca2dfa880f9366cdedc0a98469008e051a0f18a60f55f1d54005093ec85b79a666c6eb76163ae74b6d230c4491e97f7b8e208e825aec702a1ded7dfe890a94c399bba9f37894efcbff4c065b68d9382df36e26e3e94abb3ed07808992d0cdb16ab94491542bb92d9f1a1250238c691ac3a2f2c75fb08487973388b390b225c854f7be2b054806e319122c3199a91d3666120f8f06d3ed0be7c3edb1a0ce40fa51ffc93215c5b6ecaf88d12f679e75022cb30feebcecc79f2ce519ca65aea6bb8016851483876265ab5bbff98c1fc584e182b83f848fcac1ed06100b0baac23d5c41928ba66e127c1cea8463a022b86493aa0f1339b81fbd95ceecba81cba718fa0ad7d4a67c9cc2320aeeefd9620f55df09f95198d9ab7947957d3b79b63054b6c3e1850c529b0558ed7315b7e04b471958dd842b08aecec83f4f1082b9ff9630725b717f80975581c3c3e3e0403bf3b27d86ddb531142d3694be757752ee9f3a86dac6646509461697552cfcfaeda842f3399566bf2d453ebc6159d5892fd043690b5748ebae131b9de97221f3dd29d1722b1b7e1a9092fedcbab3f6594d4765ba3f15a271df0a7eb3b5b3d805a72e840ca9b6a8c83183b99ad82a57b4bbf2689fcfed91e4c0fd1be6a517cf9278bfc7cf2000251675446718466c070b9cc0cbea78a354640fe5ff50fcc4181ee24897704eddc8eb50dd2aab28d682cc5189dae0a8f8758129c35522197ed47c7a1133123cfcef43974d92d5febb26debbb27d4aaa53941e3d73032f621c2431056f9ed7fe05c9d932d7573d8d65d5facca96a686f06a70c93c9cafdcd5c77464c433e1fccf7ae6b5e3d3bf63d46abb195e6075032c63c879563ed5a91ade12f129ed46996365383d5e570ef3e6aa24662c83d4c5cdee9a3e6d95f63c5ab21f4c14e2937e815f84abe96dd148d2c567d75cb2c73460939f2928380eddde8c644115fd99bd0b8c7168536998e6dfe199ebcfbf8120ff4312a2874a91f956104e319f02d94bdf37757f5dd5106c442a2ce1ed9625152b229091a66f049ada2503310588bdaedb80587b1d47dba0c90c1698a73c2f2e1b6cd36152029e4cee9a6a15e4e05abc07522f85c550c5a1a22d3244f98618e5edaac1570affd69a7bcf429cc1a9324b28805bff812a5572aa3b870315176b66d5a1ade00281601bc91e62a7e7ca9899d960a501d8d5f55b4dbc411b0a8e685b312583286dedef50d90bdac0940af41b332186cddf537594ba4a4eb9771efb378506dfe79cdb2bbf8ba702851825825ee6a62108a96327a9e23e890b6bd9c847b535e4f6de4febe7b43cb076802ab302fb126040e31e4315b2aca1308cae3939bbce7a182d57f7b6f4e4a3e9d0d9d6ebcf15fa53312ecc73c0178d4e6a9d4dfa7b06c6b189c27916a644087394ddbf7e2930835c3f7d16d564e34a1150f1d103140da15149daaf421ed637f72b762e7dd8d864f492afdf8032e871e882f8983329b6932b07f8ebb691f17bc81cc5ae294aa3fd35ab497055c1cd40f5eb6b08c3db241b9069aa9ae98745c9a8008fb2fa9aed3ca14d441d41719b695f4bbeeaba612022314c4278ea3d9b75706e87dd7fb107b47d1af8f4f5e1a7a860234b0d3415e67423b327b2a2b98760fe53c40f7454acb43d00ebba87c62154802220eca9a66b42e6a64d5f95ecc300888721ad69cadef35002119379218b7bfb014249d9b9fb78d7729e680262acee8a783ee76e22577cf35f0c524eb6906a9946b1e29b9fb003c8fd8b42fb8b972ce8a78a4abcce884bbbd7ca61fbd715f41822779b7d8ea5935a079d1b66e30918fcb8214e3f789177aba0a20bf308cef19558826f93a15324d76e60e6d58460d66fdfaf5d172c0ab0156b77954f20d0aaeedc3893c3de45cd75b5e08e072f7ccc1cf5d02ce62c87638eb5fcbc0a42c87667b290c92314d3e6607b656ca0e90b5d68e7292cad530ac09d977c1f5909149f55b1657ae80b52c238a524552eb2711ea03c03dcdc82a934a9352a76b56f152674da10c67d5d7f4062a212c88fca97173ee157a9e5fbacaac75fd4d90aac97bfad60d2ab20d8ddd1517595edd6934ed0db64171e8d624d3499da394944cc3ec8fa1d11395872b387fba3c4778681d4e0ac406dbab627a98824d1a26cbef8a415e31dae17a68086621bd9daaf871c06f72a32a76c9b96d9ce39160b51285b29e469ae13f5375a27d973ab7f176c9e59c3ca88aaa7aeb8158531e2a91ca28d3a1fc6d84c38d74bfd9e11726d61ba5afccbbfc4ebd9730806ca22eed37f0cf99d9cad66b5987046a83c731c3c7dfa8c4aaf8da919d16e6e7604fa53d018f22d61cd4982f6e9c0b4d79e63679afa2aa3d1539076b5d5855800603ca1aa0e00993b7a006399ddd6f6d076dac3ccdd5bb3ed96bf2d1fb170563be2977c92323d142e2992a67fe3aefe0472b8e99109784529981935bef7f551fd039f5773348612e04d253d0c47ac58be29408d7749a0093851ebd2f86804f93ecb49ee32d5cd9fa41236756799c297b8d7ae41039df6dd8125ea0d5d1d347845669ce67a54c170d59aa3445452ee7f689fe55c2924feddf784832503947ff305a06921be1b17c6a0fca33c2297571545472ab1f9c28e6e9f1f0036459fbca2d13f8cd98db11e3f416028eb294af58eba2244f093858d21fdc88372cb654a3e62d311102e3ddecf3d62be3353d25b4e12c25aca3fce04bb72fb6b0a1a04ec226fc377eeb27fd9ba0e0bc92b80f0deccbb390e9508b5bbfb36dd1fc18f37d128ec0bea6554e6ec83b61fe97b2f0ba308fa8fa5da34bad5678dd51186e9f63ecbbe2de886c403453f5756db24412d363cc42936e3d3f883a4ecdfca085721453717005dd92f6a8b3f54ce34063c611068906521ab45703e957765b93fa33259ff4818329d7b542824545d5261eb4e41b23f28791615377163c98b464ca635e9d8393cb2f238bfb6de9a281789e3117086fa46272e59fc5640818d227f5b7988656439b03e226a13b6efd86cf736f26cb14eefd0c08cf52372b3a95f55d783b88a64cf19bff4c4566a13f503277a49e6e1ac8e8846398a6a74c238f3440be6518d89dd4dc6e68d4aa6ae5dd9c68e1b10b4cbed1595af7c049b43183ef3ddd7082f681007e1226a40325248ebc6eb292dcca6b517a0ab35b50b1ffe4bf8d1a062903fe89a7a8abc17c5d56fb99cd80c1288cf6c21be452f8c94c40d0eb3c23b8d33f29148695072377ce8475268bbaa4f9867ad6a600280065a8bc80b59e97d781e55a20fe38e2a636bb1bed7024acf1b3916e2c6acab97d2a8badf169ae6754f75bf70953246c86911f63c8846b84a8ee78e335350f8214f2a5cb8dd0e333d271669bf88f4bb2bafa4b5a428fb5d0d0a72e2b17e60b6f9ef90b714161f6e984f448f5799cbfb311f47772cbe5837ec40ecaffdd0e5aa734a8d194ab0abcd6c89c38741e7ef30a7d987e7eebc5e818a4b387698ecc313c3e73cad61e90ffcb45806f4473e15b05df426e1bad1da7e089e4fa9960f885401e38a7daf9bb437fabc13f5888ce033165877f455ea507026211a7101f20f7889dc3a9fd0fc9ebc3373a594c5c9ace6791c5231b379e385ee88589646ebaf43f8016484028b307a5514872b23a8d133e959c9cc94f78f7a9af2482afa22d04a4bd25daf1aea5e604ff8c9c71fc19da8e144269450dedc7fde094007928d02a4f4d37e31a013c786b7440338ea8e6aee98d2a3dd861a29b3022a700b7ffb11c624f59a87fecc28f8aad4c22fc3c39f2d161231cfc80b8aae6ccc97aedbed05b6d2dbd049215898dfac2dee7bcf19e1d4e98b2dbbdc5e0a7b3b5d2ccf3e46fcc03b8151d362f4148fa55b52cf622455bafce361c6183de89ad1625d8a31968e44f337dec0112693207a53f939711716d23ade1c0c52c68e216104c01b03603505ddb894a1d06e06438ecf5c7521098436298210f619692ad9d092779a6e306d9f1d865674e1bc42ebe910b471ccde3a15995c58a0c1f4492290bbf1a839720e804fd1b203a06ab53fd5733a6b9ae22c2e2021baf580b5d76fef61f11e54e807b78480e1ba2915d3785758636951d51ca7e1bc49a148c9f546ce1174aafc2fae71f64238ac4f27b254b77680dc2bf1ac251adf86d697780b1d8a11139606cc5b3e27cf2a03033b0d53ac1b4783271ec88f3078f66355be10bf68c7e65115f7a001fef67ac3519ec511bd622769c5d4df8413fbe97ea3c5b4278bf37942db7fff93e40f3104652217331354041646d90b3619e57b694f259361db8f22518a46b5da7881d93fd64eb815b68f6aff78403d8230f27931f528672f8e51c6f4aad869fd65e574a7642c64b80ff8cf472706b1ea11530dffdc9e5e8b80601f72b6a8853fa278235e1eaa3109189196de960ae852f030ec0062c31000a7e0d767d302227199c5708d05ccabc710e65d447ddf038fd4c5e2afacf7084682a91bbfb3a243744848d8cdcfa8910b9a4f557014a9853401aefeeee889f5a05f0d05e1f5d4d18fda41f0408f448df39c321e056c9ee9fed047426c7fc2fdb9ded14a0abb49778527953b6fd46e6b405bf55803cd1dd7210cc63c6a36bca8dd278fe527bd1caf77f366712a6ec2e6e251d89e85dc201da40fa0721f0cb3ea069400fc18458117d2697d2a040f02c38a187ac350d7e494b1b6c58cff19dfb90958c932e4107cc9c2a87121a6bdaa9fac3ac94196c66540c095cdae7e2af4c8e8da90973b0981b4fc2f256db19866445e229a3ab609652b8cf4cb856b209267c3dd3212c560d60e2ff8aa1b9f3892d284aa9ac3f1572aebe820cb0395768e825352dfefcb65544a540f71335c5445980cff6d2b20865308b3a5e79e5358037f67bfb73ccf48ff66b04377d56c3775b3e8476956f8c03290344daf216263eff144334533546da1b74ce00097b53b1b1342d5daf6f7bcaabec4398836814d523e4b85247bd473a0cb33a2b4740cd868bce1acf0a51b3b3eae242bc9dcebc7c488d34ab1241b4ac0124ed5952673fdbc77affdd476d08472b496819a6c7c09213daa1be8c898291940e782140a3a71fcf50cb6287a88e42be682c0846431ffb81fc3f56278a122f5cb240bce472625ffec4686c7bc17091af218b7e9c20062af72389ac2e1649392285b03ea8df29eef74a0d5749f71a5bf99795d208d1f078a2ea98310568462b36a0e4d08d49b2a35f6b324fdd52f08c44f32baadbf30da9f1674ecbc982dde457e9d1e678efe9d0f0a95625a342a8a192b99e6b5bf8739a883d5b0936255779c34555f53d7a54ad91db4d0d1e9";
const response1Bytes = new Uint8Array(Buffer.from(response1Hex, 'hex'));

// Add a second mock response
const response2Hex = "49e6379d515b75ced31f850973603bfeee028aba9486c3fbc639a11371c674c2a899666d276a435c451c9c920785577b9814b76554d596d202d689e78267fc934a08347b07c31db6be3db763a410a7620cb23bff075f26229dcc1ce85b495ef4255124bddf4beac40a2642bbda9d370bdf810163842fd69e549adb0aa3fa5d2f5bc50cd03c4167c12bd4bb77eecb814b9c7f7617aa6d0f76c774eef414278b50e0bd62346d6ab752fa0c5abcccdb18b33463fec8ba84cf67c0b9851f9359734e6122642a3c300c022f5ac9758dd1f18245bc662dae8fa0196c3f03a7da3d9a306a1eab165e151a92e0692d002edace31b3a0b6fe3f13e036f2a56eb7bb2a97c41bdaf4121a257c50c6d33f634416b03d16f78761df00e8158ac7d54d67cc3784aed00091eac98256a1432603fe2bd17d72d9cb2fcfeb0b69db115a3523ee3474751906ebb8b4161d84c29b2e6b0138eb99d6f0db3a2c11d1249619fcaa555d3a5b33c8f7a090807818d6390e2d4e8c5cae803b6f7aa1b603364e4791a2d81b6db47508df59f17ed6268ad4ffaa1dad60fe880ab717acad092a960920f12cfe1dd5f05542547bbb7a6d2a9a4a23c34515c22aec482ea03c0b5e17ba6fcc8fcb183af7a804ab04ced929af00e01b695ed39115fd818db249871f05c30ab66355f5780f17230a58b249b3e60d2e229521501880597574753fbc3ffd9bf8b1ffb2cea477c36f2d8b48cd8e41e167955b8f97fb668fd290fdb1ee9f9b7f1f4016df02795705e891dbb48815a1d725d544dd551c2d0acb7dcb58026a4f9fe412d911dd890d745ed589c512007243787a80e9e244638169d10736981ff2d457bf2b429c8d89c48298edda38cdc95a96a6c0076fed09d7a947860f1e2545b816a7e9678c0cd0703510b2a40c90ebf509ba046a05da5978906dbb0dfe0feecb967440c25173bce919f389017364d89b5e401665bb535613910ecec8f4aaa750692f58ca8719e6af80f2fab1f6d6e4f53f094c45b54205dfce3440068d117464b38b7abab3deff2959fdc895537e075202636f97b5243a85013c069f8f76de2a122161a10f1219ebcfbc4981ddb2678b26c8a29c0396fb86eab6835a591c9bf57ce797b6ed40a1c9fe2c4d94336d634362bc32b030279419033865fe6dacff4b28e10b665b57186fb6efc05bc767882355f71c655d584f0ee509c364e6eae9957bd7023beabe1b2bfea6e0e6c3b2887ad500e669a590edd90b7b2ab3865f4da0df6ba87397cdde1aa772093586cd9a10b77358ab0a722505f2f947a1d1330fd22b046bf183d9d90f86fb002521b8ca218d1284a7dbb15f8c50ecd5da2119c86831d4838f7135edc870dd12e3ebd9ee79d45d5a9d5b63d92cbbca7d6c417d2bf5c9e72c9f12608310cc9cb42266c1c2f35ca58cfda9a353c1b4235e5a85d2f390544b98cb70ea112675aeea05cdad035c55f2ca501d37153ee42815a40c8b4d96afbe243f4ea058b86ada51fd7dfcf6321c464971a3776cf61f41da1279731f1b721670ee465e8ea2c38a1b32da986fd63d5ebbff0843a616fde7141e497e602b8818d2325797a974867e628a60c5f5e4987e74fef88411aeff602500e867cff4b4850038671f775edb79245fd1a6a4154bfe2842dc4a1e97b17fdb3fbe3cdd570e8fc413a1d538b912fa436978d39b1a5ad922b4eb690b7f77a7e8b2d5781888e6cc3830e9afc31de4de9a4d2d34610b325e2ce3ad8d2830ae472637721db9b6e7890dc9d6966839b5c5e04d4aa42d6de802415ae2ae5147d37bb4acf43a5eb2b97f4e287e8eda98d490215a12e53c4d08d5031cb1ef93fa9e4b7ca92fffb8a03d891c68a166240fe2221bc831b8f40ea822ffa1ee0fbdbd0303d4697b7726c8a6485e5bab953d81e2c799178caab9d611170f691850646a43ff6409a433d1713e4d3bff0b7970804c408b165a0681d50e06ff6990810d945ed094d4c203643ea2ef2ddd13281aeadada5d7cc848995f7553330972cdd08f2d347455f080d7e7c4141a9c5f015fd8ac18230d56c1d8f15013a70b4e1d82a64befd6b40e5cb1dc04ad7083164f1585045dba1137f913ca2ae5b2a39396a0e2d6aaa63304d50477572eca00d9f9a6fe16b47828f82f957d1487fe586748a6420ef846c2c67d3e93de1d7aa28ec62dcd5922c8ac93ef16ffc3b2a1fee6df3cbce4635e36cdfe327bdaadbe32f3280c1b7be3c3ea4e39d276eed3d615158d8f62d40e1b1f74d224e5b47bc60a5e4417ead47d2e107aa0ce7c122ea5754ee29d33204d0cbb245d8f4d563f9e49761ee8415aa7bb8a2a039550a52dbc0ae810aa5c8518c2531d249c30864e92795992e825367d70ae11028eb4987bbb1af456047f1bc4cabb825113b73de13bd7a808068af5b4fec940d728833d94bd1d95bf6fa97d482080402cfa0ec035e2e9b44a30592c3ca99411dcc463d54e3a41dc6fdec04b3601724bc881a6cc30685377570c65e208f1cbf1d4295061022d8751382d673f2a1135b03769d1ef0282a9c65ad579ae825adaeff1714ab083fb2886efbee0042e8d566fae8ae032a90ab7166a98ceec97d28cf173b329331a5080a7a7d4eaca07232ed84a9e52d3067dae3ccc583eb62b8810ecff169f4e883a3e5f4fe1773db5f6879496a3679c422912f418264bc82d0b46fff067dd21b4780508008cc9a1240c61e10a152276e7b7eb841bf1343a440baeedac1d362334e811ef9d6682c0470fdbe411e3372ccf415f0c8e21bbad995f51d18071f7e1d8a387f6e0f78d161887d3a2e75dd9946d7b72b82b0a2394e03fc6e62d51e3d7d750598f010d0575dfe0f9076ce8cf90b37d6c32f1e74139ad3c9421481f407fef9500f583deff0927ca85ee3d3cd088bb77365a75b3e1f6d4f01d80885e4a884c3200d87e9fee252879ad6c4c14309ec699ca0be37a6e08e5c2a918d2aa841d41efe6887d77dfbe308fa9c666e998e2d950a1383a21576734324aef7ecf2eb5bb79815552c7626c9005a8d87494a5c7d821d5474cf8248f720bc2f8647ce076090a4a132198c323eee2e2592641159d626c2f682901fa4608c909b6b2222aa671cbc29d1ca1615f091a86c5ad72c3211bcf42d98da4751a8dcd6d222e22c83d6d5968c534dac492a5013ccff8b3b1914bff718c7cc8b661e1c040ef0b00febe594613e5c5cc534b451f4bd5505c28df53df8f391b8409f88e6d1b1bc30e593e64c6412b0a44ee3960c47153ae3dd792ade2cc826a5d8da14c13e701979372a436d87e9caf95dda5a234a7e6a019f949299ae8bbcb9803d62f1a1d4779a7cb51df74e90ed2a8464479e555c176671f5a8752bb0d88bd05e0192f2ad7a50942bab7e980728c881abb9591c211940302b7136849cd86f0adda385186b9363c8f2761e3ea1bfb6c0f973fb85e6cfc3a52a25f9e60d3e6092c41c04dc86c31530be41a770e29f315be8a0380a2fa937fe99b953304525a497ba51afa3a11ed326041ac70f4fd6ea684b2df946641a5e1979610fe302ae4e593666cb209491c2a8c591aad2b92cafa60c8e10f5eb86a61773622df6652cdb838525cf2be0d57c380e107f6a29d8a5dd1d20b5e19eeeb2814599f80c18eeebfe66482586be0dbb67d30a1fee5c5045cd64db3ef9139cf8d3af503a350e4a4311c1bdbd1a1c1d25968cfba4aa34f99d78acef4ceb31cbc2995cbd4204b3e49d4b5e7ba71bc911ac60b54da61647dd3d729d13084b1f788411d5d599085758bb0ef40f5d1af6d0a06271b101a94372fe2c873bd605e50bfb463c18aa4afff3d4282296d28a8392fe367d6db9dbe7b08686f1748dd6c48841400f14731f8ec9741d672c996adfb6b3bdc43af9d2771762c37945b3dc0fccb263c389b4e63e08a5ddb5cfa2067d3745bc094d5f664ac583c245f7c2a3a6d532d250e1d91577606f700c97774df8d4027556398e0b8b82c09b69740d3f161a22efc6743980fe6550c12dd5bc855f24a1322d3e537423534692509281408f0e8f4d9e43220c205c33c91385cfe4f1e7f6ceacac132142e63d6b80bc56f0e3728407bdadf6e3d348ea377b10196441331e8382fb638ea8f3de265d8673f321df56d75e36adabf2a3edc0576c115ae426cc3b23232994112202069515e8aa9316ace9caca9877e69bde5ad10e1d711778351de44fea2aaff09cfac2673a0c7b119d350fec1bc788a68d77a26352efd32b33b45b7301ebf1fb3428571098ab08196accd1ee95cbf63083518acd4fd05b3a5435e7d62c34c03ff6ac2e2b5f5266cb45e02d53743a767f5d9d55b51ebdca3ac0d7239e67cd3c8d80b0743345657723a210b4c0ae89a278bab1c10df3ef02e2f5f9bd7ff1372522e133d4e80ecda207e67f8b1f224c084662b1ee69eb00e94a61398f0c2eced211c26567f95f1e991ea5c052e3c464c9fcdf6fea3507054160b2d675a8c6375de3b80fe34586498bca65692b04339c3a929650ec3a129a0d20a874c48c90515d0481c6db258d5cbd8f699dab63254d023b955a99c2ccdb8b344e724dedd44499235e51b09c1a3c9e7a2d9b69652d242fd929508a4f89abf3c37764c5f8838c0a93730a5e56ec51102629a188b5792fdfb50eceb014df29605411719336ec700c953795a524bf4ebe8dc3862c0c9c3a5367ffb1ac6457babd8724ccc222d032e41d5ba5e2c70b0181edddb5b664f25c512a4958d78cd3c27ef8a90ad60cb0d12f8e6c223463b9c3b3c1f92008692d9a15429f99071e6462ee2d4717864bb046240d17aff2eb57aae5f155b72024a45c6d1273849ce330faacc0f250484be9d694b4069d190837b619e94492343e747ce6980df511a76b829f6ce4055ede27c575301afa4ef52af759ea447f84a8e9468e78d9019893a90a65a6407c156edf032eb40fb4d7c97df52f2dc4c95cf968d7a1a27bebfe287ccb8e48383a58d0f005a78a16e1b1abbfb583ba7b7c397ee265a9aa3992ddee1bf7931d8766806d6fac5484f2e879a67340c92a65dd7b1f4d60796991d700abe3f5b257bd68f38645b159d03e0a9146edfd55b1184169fc9d594b6a2efc134d1f69a947b1a15f4f392ba317b12491ebc8476b6d71867043675cee614cdd2f469517ad51c94d409b75065b5a88318c316b9d04e7723aa700a8ed41edf5c6c0cf78c59498ed82e65c516b3b2a080f56096689e38a964e81b517ed5b1209885395f380dae8ca69d5b28b1e5832cd2c616e3328f36f3f692a10059c04d4e6f8a82bcf896a83194c1d4a940dbc9958b6683ad9dd9530b18e43722ef49a5ec43df411d7b4f1f804d4962acfefd2eb3d5cd62f31cf311b0c4afa7eac287884c79d83fb25835bf21bad031b6bf746fce0813d1557488456750d24e181c562d8d11ce118560efdddf1d29d707407b7c410c9ac6ab8a9dd60f6a322ac95adbc1699a0c75d6a4501ce87455f7718bdd9e87c622e64da1940a33e1a11592979c4fc291446e077cb044fb952c5b364309e9cbcf34bc18a51548289948ceb9c97d8607af65722dda92900feeb9c055b13387ce2572cd27bbaa0fa08bfe065e2f66efd471251401e75b42b66b1230d1dd96fb61b900e6c4f0893d726b7201782eb8518e79d727645a7f80f94d02a692292da41c4094bb714c0d34ef535bab041e908915270abc53e46d009c31ebccc8c6569121fd8e4b636a24b37941f9747134ce6cf77b37d5aaaa79b4fd38f9ad29d7bcdf0fa6e8836aa63e253d3a5f78017bc5b481cefa251c5f41b53f0fb75291ea0aa50b41e69d30ddd57e1a296abbd74197b618f9b44b2b036903087d3c0da6fa058ab97795ae17a18734c99a56f81b4575bd0f028214925b2c4a6d34e790f393e3f5699277cc765781eac3b4fa6f944cdb0049113636b958c2569064c4625ed0710fb73ad64fc44533f8ac0537be0e8ae4bbfe31f7ec6a9f5d08c29e1aff222e74e1e7ff727d04e5fafcebce4aaabaf5a9e90874daf20217bab10eaf77248027ae3a2280505e14505ac9b6b7dde289e9cac41ad60b41a2242f9a9050b554b4d32d70f19291090cde82a4a1651cdf8b7b1cd151da3f3e2ec03d6cabcdd53486ad3b780aa8334bcef94aac2d214e0b7e1ee3dd51839045742b5b6c8c3a28f5b514a5bb0e62ec0282dbe72b832277a38cafd3482642a1fb8b0d75e30cf860c8ef17404438ecc596181763707debb495b318f8871b6cb0d51afd16f450fe80949ed93a5ecdaa997ab9166c9ebee6422f471a94a74242221fa9ee09d2c8fe19bd560dccaa76c624d32c15d263ce54208c7aacdfa2ce7f1b4a35f7d87c389fd4eb4b2de29a7b2b6456de7aa131cd6f1557595fcbd3c171b08c33e06511746ed2a20d11ec78e2e18d44e6142ee82fb42de51e1a4b45a8ec46155ac9a606bbfac2ec0616362cd5e8a6f6eecf6325921852f421cb117ba4ac0f97c7a529f2e4c312d7c9e8d92926925f022c8f31c2bce97a9552d7acc75dac338ffefbacbf7aec84a638a2be80a097a5661b4b5e0f7395dc98898cb4327b635e8dff20e00215845a1991a5b7a23619caf9709d120925be2323b0dab455fe69ad5df846d4128a37beea6731323091245314652e8b50ae5a6c15efff8f175d985d9d9e7aea8ee8f151b9c3d1bd9f7cdc3cd55d9330f83cbc4a3d37ed8cef03578808d61449eb0bebdccb669df14fe60a3961809445edf5cd1e95e8a984fbe52b6b83b03fe0ac56705d55febb1383590ced9636259d473580228e44dbb6bad44bc8409a63df7174dc10f0149fe8a03f7d90e946555cfd5c7b28dac7a2cba7f60d793c7f43a61be2ede74ec821e827141279ab7ce3d32b5d124ac860df528eefa6f464a4bf622e80524c2da499b231c1040980b3c008d6589b0a242bf7f95be13f6247b0e28b95a67b2adb25b56a26c3e3eaf1524fe4e9d3c5d5108c8e6770824a15b1e9d8e8cb47a50720c43751a997558f38f19a1f11386e72d9a5c02b46e73744d4f0ec66a3a24b9bb83cd69d4f2e27082d93caec96824398de42d577748b5b28c160890774b5d6ef76f3268e7670dcb2c80fdb8defc41e22a725e790e8cb1eb031fc7d8edcaa07efa5243c9d8dd6c95067d3b2dcae491e4eb6c1886c03cbd7fe9629610b5b2f76d229d7751330853dcfa09441da7f50cacc2b66d7c0e95f39dbb482b9d133082ca2082d79c42f51dffc41020a86ffb3c24ff7a1aa18e12f556aa18dc5e284b6a3efdf695cd1d1ffd34ba2663d7269d97c08d6bc6cecf3a6baa6d67fa9e3816a8dd6d05729b59a16925e151f078afa5fa6c187e62f7c4f201bad2b09d44e4af06bdb7dceb1fb37d459abea28ded0d86088da4f6f0aa511c31dd53765d3b1b866aa3e6667711f328d32255a6a84d057cfa456668f63f3518952a13152ca1a0da274e9ed172ee0232ddefa17d179cde126d14130d58a4a6c6721a1aacaa87750bdab94e18a926152fc1423b00514278a3498f177c500680bb47607235c62795a96eee176505e7beb28ce4bf1afae2ed3de1728835545e9ca8cfb78c1936340e909648f3804a6a24c1cc871655ace21d752a87b3767651decfc8fc207cff65b055be44e6e2059e5de10a0e73921d7f63ce6ffc673b3730f2143daa6acc603d9786bb202363b1f0682a591047e36b3915da4701bff9fe867fdf65fe44ebb8c7cf29ba49ce95b6063fb3d37296267a6587dacdcbefbdd5f8a9554121d31cf1f27d8bd9630034efcff80afd77e28fc665c70122b57b1e5e22f8c41310780d4feab27842bbb5f23fd07ca0eee2d7e65c0822bfd019992129709172d8d03e32d070050b311c2687f7340d57d29cec1fcf7f97542d1396512f7f51917587195b05ddfcef8fcca7d2c654ad603a3ee71c0bc6bd00aaea520bfd46b557154dfa00e1844288a44c203ffe80b4e171d023707998e5840347fc9a22f3ef427f6a447109201b21d60b90af7fa2659f634fa762cdad9a36e30ffca65e91f2687c58e800386962f9f27ce6751944ad82902e2ce77ae9d7fdc5a5af4d062c1e7593ace50076efe9bcb714dc2d53bbdbbe6f6096855ca12d5bc48e620764de13a4f4f5c49dfd5d9981104610ce9fe39292a0cc348609a16c4bc75e105e5f0378c5e89c7197c361625d5f4036d62b02e9e3494a9a9e00615d64fddaed8832e3434e84d3ed73fa1c1b4fa1e090f643c3620dfbb944c78fbee3d7427bfe3e4fb2c56f401d969bf8a12f20080aadfd4c430490b9fa109ebc5707ba821b4b4a6ac8383fa78186e55c5bda42193f8e7548bb7a578e5f278b4cdd265e96d4cdff58369aedf626544582b31e9cdf10a4dbdfea077a4d69bc33d43771abaf231b3909b6a03aae0e0d53a01afff75b5457e02567f7522c42111fc1b23033c793975e8d81ae6649c5a0618615bcf4f49dd6f1ec667e820e271dcba375b59b0ddddbdc152e010c2126da02493d5549a22da71bf77c4426198f1c0553bc6d24e564210e3f32e840125cdbf9bc01ba4c808e98656e1024d0ee57a54a4634fbf50fea3da2bc0d95ddfe9088433cf832272c1a9c358fdf55720299b5cd3fa9fa9e4f18703071686f73074596957827f586ac381b7e1ba0880e343de162fa2b48a9eb8c1acaba074b4b6a160b99b203371d5857f2b8da14f94604b32d4aef6365b712d30ba094f3af63018be6107d332402d267d12fd6cbd74ee25ed517d22659d7bd9cce34b04a0f9cbbec251c74e11b6d81759a00e387e7cebbc3fe18c4c7e56721031b43e78de6806898d8eb0fc808a85221b2ff7fb054204d8d3a80934faa633a7456c0b52dc5c2150caa135df3155804452e894b262cf3b969bbd5da29a0be292bdecd3e9c65b561e9bfc2eb5aa49a166c2e2516c3252ec8686ee193816ba4dfa8e4d9720adc46ce8252bf963eee3c9928de16364f5828d0fb16e8dd34f175e9fb2ee7c4e7b0d3e74f67d24be4a4eb986ad1621f5d4553c06b2e9a2d7f96f41b904e060282ed763782c018929fd4c483ba2e1899733dd4d2e1e1c527f2e37d9203f9ffd32e91940b3497db38a5f5d88cddfe943f075c13e345d84c5ee1e60e8b76d3ef54a675b7a95856914a9dd3e294daf5930c0aa5da3af7834c3d64461bb3771813eaab526091f26a721e5e6f303c3e0d8606adb8ea7ee205bc4f8753555846f3a64d770ca287c02982603a6903090cb5782e4a316f38725eff86621dcfae276a8342543caeaeae2857399fb3e147118f5f86123dea51d24ed1b79cc8f494dba07b8a7e0e17ca3fdb0ddf513518cffe86876cd93b2c5e7f601048dcf6b4ea44801a8abe18b08559ee2d14aab3dd4fbbf0e055cacb2da14d107c04535b64ae4699a69678d1dd8414504008114b1642ebe6621267883861b8270923525767fe7470aecc9320918ad2897400ffb9630312719cd365465bffcdb9e1a12c1ca1a0d8f7a867ab66c82e28f106657a69a9a01e8e5ffca4edab38ed31a78dfa556b5c87eaeda6e8dbb59c2d316febef4d758e7452680be586d5da6fb99b7bcef129caae39651d9772d32a69573eff6249b9f04b7dba0938c047f72327fca71f1e806cf5ef7eaba6841a778868c80943c7aadb0d6daefcbad53e546142b2c9d94840b90ef0f0a8e53708b9a2db41d5f1eb7a55c449aed511ec9d0d7b8eebec57aac2bef5ae416e993bcf732218e6e664471970f9b44b671c6bccd519c540e628fe8ea19212501d5bb6d8a6ce402103b98635953ff21532d4060c93d2f3883cc28cda4f5500f14558ed027b9bf282c935a0415274173064172f841e61748e1dae4d91ec7820f8a7d5505bfe3d3d1b96ae268dfd761956e9b5ed811e656e6db5f991f25984de9f206b8a55cb06e2a012d93295ae488a104d1a507e423deead18d04f87afb7803cdf3cb49f8184a5eb6b1b43f1f59b8f9f789fc29018712abd03ff3555d0d0dfb2af3a897873df5fe90b63d36d7dccad8689d795a6bb1eef65252168e016da1a7a60d66287cc9c8334a3452a46fae0c3ed88c5cb7fe1ad945b91738c4013b61e439f792f1ba9d692822c24e5ab9dd6256adc499d3b255b1d022ee2773b1ccd44bdb8cd1d6afe4f8df58b5452d2f6920db5432cecc64d547dc00278d87d8391912683393ab5986138ddb29c0cef6706d6c99b488d2eed4920d8d5a3e9b78ecb75ec7c5b77d4ef2c2889e719c8981e7e103394371918b6c369b75c75ecbce5bf026ed457dfe344f66c1005671291e5adafdcf480b55762f978ab622bc11bbc431cef29295665fa3e13e70c8c23634f3655e4b6ebc7e9479e3df7479bf9d6555cef353ddb8339ce6e70ec715e38582c473da2ee5ee293786dd0c1a3870452e466e1dfa7c1d99fb6dfb2b00f9fc0dc7e1cbb28a47fdc65b1ab125d267b7aa52a0da53374f30dd5cdbb8d7b9eb9cdc9278e8a929b67bca6c45c3ad7f33012e8ccce7a4d1401bbce873543179856ea760a966947a8d1a479f5360eb4cd75561b1a1824c4fa2619b058a73d0d138b83d55f519b0607c736c692f99a4983a62880a377d7bc82fffa7d560c23e236ee703d27031d52c3a329639116ba4a16b4ff9330874d110950721d6221c0150ad4aae4e32cb385169aca8c2d13598fab536a99eaf4299421f573017318407f5f56ed97caf73426d18a6f01dd28b39e7eb9babe0dd3c614f04281877cd2f0f1a9a1ee1f51efbb40904b784668053ce64f33bc14fef3195c72cdf70fa92be09b1d1e5b38f859db8a4636ed48d8d2a2d4d8eb6ec0412575729ff8680eae5fd0afc22a1cd6bff7c312c2921499d9ca8ee55ec63768e52e6669e6b5c85cbad4676906a48077194744991283260aa843c066bc37be97c8cba031f8d44985ee8e795a91afb904a7cabfe200f5451187e87e1e76619dcf4a6f9e25e860781885ad1f3a36c1e76042d5f5dc5507e7dede9ce97f2e87434abe82fd592b08409d2aaefbfd7fd44d3f8daf0a86fb86ff0a97d5724e330440ce2fc978dbe1b3dfe76dac6efa8753fa69ffccd35300476f31bb0aab74988c6ef940fbb19316a0d4433a6da232fe618aeef61ddd1ebeeda41f06b5a5b88fb21215f247ddc40162a341c67dd2a2baf4f378561a23748152cd3583adb3bde57a78967db3f33b232710507c5814e875de3db2209752837aa508d0eba97fd28c8c48da5175a9a853f96674262d242cea1dfce5ff986ef3c286778f503f0df6686ae669f7a6db93f0fe3a37ee0dda482101070992a21f1d4f63ca5fd3419f2e1d58c873c1c16e40ed4a586923cc7e6be96345cc61c64110642010612b822ca8d1852aa0c24dc912e8510e52a8cfcf893a0e3e445ffff1c3b2107a72af508391f3ef2d4412eca01c83b9cfc53abda60b47bc9574d79b761b18a1f46636f1edac246c844ffe6769b824737eb4538b47b715acd43da04fcdad6e75e68a3a19adb8d8746a0a98da73509bcc65320fba8945ba032d3d98f35185fb8252c38ed7f80b06247eabfa0d492f25e2c84dd0dbdd06cb17a40f5d71e0fb3a37129a157da85e86e1fc1cd4b1bcc2518039bca74eea1c4a3ad31649a474d3956583605726b86fbf96b3ddec351b67e41511e6ffbf7d165839f9a36f6ae3a02240e23f4a97ec24248d3347fc82fb25d0b0d9d";

const response2Bytes = new Uint8Array(Buffer.from(response2Hex, 'hex'));

// Track which request we're on
let requestCounter = 0;

const mockPsbt = "cHNidP8BAJoCAAAAAsj3m3yOO6K+iM3Hbkcz7qcBBDjIBJAuoxYCUgdnnVwnAQAAAAD9////1o8/lfWucFegO7xfkBY8odoVpmMA5SwHQW811DyOq2kBAAAAAP3///8CgJaYAAAAAAAWABRCiW1F94m8yQc4ByZD7V4NiGpXyDtDDwAAAAAAFgAUCA2eHmsBICP7vb0lWtrwtONV0+0AAAAAAAEAmgIAAAACDn9HdlQUpZYM3ANC1UdCCE0XuoRaTUwor0KJbbNUFkEDAAAAAP3////Fvtq/YM4A/fksjJO4E16Yw3gbZ7Grm8TcKdWRTeQcPwAAAAAA/f///wKA8PoCAAAAABYAFP0LXGs4xWPLORvXJc8keqJdkP7vC0QPAAAAAAAWABSX6LeWTvz4Ode0D4X+pHGN4/rZrdwoAAABAR8LRA8AAAAAABYAFJfot5ZO/Pg517QPhf6kcY3j+tmtAQhrAkcwRAIgJvt1Nai1IgQ3g9mDblrWvK6alEPUrfDJYvecZPkP6psCICYusN+PQT0m3OvKup1VQtKwI9E9FIx4IgS/5jf014Q0ASECIaiddtHJ0kVH1GJEMn7C9KY7MljVE57VXbHgd+FC2tAAAQCaAgAAAAJknHZ7BPoeIgYZhwbnzd4miOFI6owcVKXe/SkRWbNL0wEAAAAA/f///wUqjtj4a9OYCIGBnz2d7rr+v7uAt55tjpuikbEre3NzAQAAAAD9////AkCGmAAAAAAAFgAU53oOuzU0aNlPMgX9/NXdQMyohBuAlpgAAAAAABYAFDYjiTbYhINIraYNCMGPODV3yWPjAAAAAAEBH4CWmAAAAAAAFgAUNiOJNtiEg0itpg0IwY84NXfJY+MBCGsCRzBEAiAXy9x7IO1NkWgk6npgqRuF0LOes2WR0g/QOikqjj6q1AIgWUwrQS7BTngatd9zmE7isGdOZJjwcZVUUOHsIioAgFEBIQM5ZjGNwpH3rh67dcERLi3mZtncpTnhc/MbQjQrtpj6ygAAIgIDVLt7U0yEHQvtTDlGaqEdnjreH8LBQ1ICO4m/QArQknsYw297V1QAAIABAACAAAAAgAEAAAA5AQAAAA==";
// can't have a static mock as the URI has an expiry built in
//export const mockPayjoinUri = "bitcoin:bcrt1qauwhftqrp57q200pp7wx75dfwfywrmla2v67dw?amount=0.1&pjos=0&pj=HTTPS://PAYJO.IN/ZFV5JGYXKQ3NX%23RK1QVLSWLM5USRWPADY9GQC0UMKAPSXE8GSJCYG23RHJ3WUERW08RAUC+OH1QYPM59NK2LXXS4890SUAXXYT25Z2VAPHP0X7YEYCJXGWAG6UG9ZU6NQ+EX1DRE27EC";

export class MockFetch {
  static setupGlobalFetch() {
    global.fetch = jest.fn().mockImplementation(async (url: string, init?: RequestInit) => {
      if (!init?.body) throw new Error('No body provided');
      
      // Increment counter and return appropriate response
      requestCounter++;
      
      let responseBytes;
      if (requestCounter === 1) {
        responseBytes = response1Bytes;
      } else if (requestCounter === 2) {
        responseBytes = response2Bytes;
      } else {
        throw new Error(`Unexpected request number: ${requestCounter}`);
      }

      console.debug(`Mock fetch request ${requestCounter} to ${url}`);
      
      return {
        ok: true,
        status: 200,
        arrayBuffer: async () => responseBytes.buffer,
      };
    });
  }

  static reset() {
    requestCounter = 0;
  }
}

describe('PayjoinSender', () => {
  let mockPayjoinUri: string;

  beforeAll(async () => {
    //MockFetch.reset(); // Reset counter before each test
    //MockFetch.setupGlobalFetch();
    mockPayjoinUri = await generateMockPayjoinUri();
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  describe('PayjoinSender Serialization', () => {
    let sender: PayjoinSender;
  
    beforeAll(async () => {
      mockPayjoinUri = await generateMockPayjoinUri();
      
      // Create a sender to use in tests
      const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
      sender = await builder.buildRecommended(1.0);
    });
  
    describe('toJson and fromJson', () => {
      it('should serialize to JSON string', () => {
        // Get the JSON representation
        const json = sender.toJson();
        
        // Basic checks
        expect(typeof json).toBe('string');
        expect(json.length).toBeGreaterThan(0);
        
        // Should be valid JSON
        expect(() => JSON.parse(json)).not.toThrow();
        
        // JSON should contain expected properties
        const parsed = JSON.parse(json);
        expect(parsed).toHaveProperty('psbt');
        expect(parsed).toHaveProperty('endpoint');
      });
  
      it('should deserialize from JSON string', () => {
        // First serialize
        const json = sender.toJson();
        
        // Then deserialize
        const restoredSender = PayjoinSender.fromJson(json);
        
        // Should be an instance of PayjoinSender
        expect(restoredSender).toBeInstanceOf(PayjoinSender);
      });
  
      it('should preserve state after serialization and deserialization', async () => {
        // Get the JSON representation
        const json = sender.toJson();
        
        // Restore from JSON
        const restoredSender = PayjoinSender.fromJson(json);
        
        // Both senders should be able to extract v2 requests
        const originalRequest = await sender.extractV2(relay);
        const restoredRequest = await restoredSender.extractV2(relay);
        
        // Both should produce valid requests
        expect(originalRequest.url()).toBeTruthy();
        expect(restoredRequest.url()).toBeTruthy();
        expect(originalRequest.body()).toBeInstanceOf(Uint8Array);
        expect(restoredRequest.body()).toBeInstanceOf(Uint8Array);
      });
  
      it('should throw when deserializing invalid JSON', () => {
        // Test with invalid JSON string
        expect(() => {
          PayjoinSender.fromJson('{"invalid": "json"}');
        }).toThrow();
        
        // Test with non-JSON string
        expect(() => {
          PayjoinSender.fromJson('not json at all');
        }).toThrow();
      });
  
      it('should create a new instance when deserializing', () => {
        // Serialize the sender
        const json = sender.toJson();
        
        // Deserialize to a new instance
        const restoredSender = PayjoinSender.fromJson(json);
        
        // Should be a different object reference
        expect(restoredSender).not.toBe(sender);
        
        // But they should be functionally equivalent
        expect(restoredSender.toJson()).toBe(json);
      });
    });
  
    describe('round trip serde with modifications', () => {
      it('should handle configuration changes between serialization steps', async () => {
        // Create a fresh sender with output substitution disabled
        const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
        builder.disableOutputSubstitution(true);
        const configuredSender = await builder.buildRecommended(1.0);
        
        // Serialize, deserialize
        const json = configuredSender.toJson();
        const restoredSender = PayjoinSender.fromJson(json);
        
        // Verify the restoredSender maintains the configuration
        const originalRequest = await configuredSender.extractV2(relay);
        const restoredRequest = await restoredSender.extractV2(relay);
        
        // Both should produce valid requests (can't directly test output substitution config,
        // but we can verify request generation works)
        expect(originalRequest.url()).toBeTruthy();
        expect(restoredRequest.url()).toBeTruthy();
      });
    });
  });

  describe('PayjoinSenderBuilder', () => {
    it('should create a sender builder from PSBT and URI', async () => {
      const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
      expect(builder).toBeInstanceOf(PayjoinSenderBuilder);
    });

    it('should allow disabling output substitution', async () => {
      const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
      const result = builder.disableOutputSubstitution(true);
      expect(result).toBe(builder);
    });

    it('should build recommended sender', async () => {
      const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
      const sender = await builder.buildRecommended(1.0);
      expect(sender).toBeDefined();
    });

    it('should build sender with additional fee', async () => {
      const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
      const sender = await builder.buildWithAdditionalFee(
        1000, // 1000 sats
        1,    // change output
        1.0,  // min fee rate
        true  // clamp fee
      );
      expect(sender).toBeDefined();
    });
  });

  describe('PayjoinV2 Flow', () => {
    // @todo before this test can succeed we need to get valid responses to the mock
    it('should handle complete v2 flow', async () => {
      // Create sender
      const builder = PayjoinSenderBuilder.fromPsbtAndUri(mockPsbt, mockPayjoinUri);
      const sender = await builder.buildRecommended(1.0);

      // First request
      const request1 = await sender.extractV2(relay);

      expect(request1.url()).toBeTruthy();
      expect(request1.body()).toBeInstanceOf(Uint8Array);

      // Send first request
      const response1Bytes = await PayjoinHttp.sendV2Request(
        request1.url(),
        request1.body()
      );

      console.debug('response1Bytes', Buffer.from(response1Bytes).toString('hex'));

      const response1 = await request1.processResponse(response1Bytes);
      expect(response1.version()).toBe("v2");

      console.debug("version", response1.version());

      // Handle v2 context
      const v2Context = response1.v2Context();

      console.debug('v2Context', v2Context);
      expect(v2Context).toBeTruthy();

      if (v2Context) {
        // Second request
        const request2 = await v2Context.extractRequest(relay);
        expect(request2.url()).toBeTruthy();
        expect(request2.body()).toBeInstanceOf(Uint8Array);

        // Send second request
        const response2Bytes = await PayjoinHttp.sendV2Request(
          request2.url(),
          request2.body()
        );

        console.debug('response2Bytes', Buffer.from(response2Bytes).toString('hex'));

        const response2 = await v2Context.processResponse(response2Bytes, request2);
        
        console.trace(response2);

        // Final response should have PSBT
        expect(response2).toBeTruthy();
      }
    }, 60000);
  });
});